<!DOCTYPE html>
<html>
<head>
  <title>Reaction Time Game</title>
  <script>
    let player_won = false;
    let player_blast = 0;
    let reaction_start = null;

    // Start the reaction timer
    function startReaction() {
      document.getElementById("instructions").innerText = "Set...";
      setTimeout(() => {
        document.getElementById("instructions").innerText = "GO!";
        reaction_start = performance.now();

        // Enable reaction via button or spacebar
        document.getElementById("react").style.display = "block";
        document.addEventListener("keydown", handleSpaceKey);
      }, Math.random() * 4000); // Random delay between 0 and 4 seconds
    }

    // Handle spacebar reaction
    function handleSpaceKey(event) {
      if (event.code === "Space") {
        react();
      }
    }

    // React to "GO!"
    function react() {
      const reaction_time = performance.now() - reaction_start;

      // Determine winner (player vs Bob)
      player_won = reaction_time < 500; // Player wins if reaction is faster than 500ms
      if (player_won) {
        document.getElementById("instructions").innerText = "You won! Select a blast level.";
        document.getElementById("blast-buttons").style.display = "block";
      } else {
        document.getElementById("instructions").innerText = "Bob won! Get ready for the next round.";
        sendRoundData();
      }

      // Cleanup
      document.removeEventListener("keydown", handleSpaceKey);
      document.getElementById("react").style.display = "none";
    }

    // Send round data to the server
    function sendRoundData() {
      fetch("/play_round", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ player_blast, player_won })
      })
      .then(response => response.json())
      .then(data => {
        if (!player_won) {
          document.getElementById("instructions").innerText = `Bob's blast level: ${data.bob_blast}`;
        }
      });
    }

    // Submit the player's blast level
    function submitBlast(blast) {
      player_blast = blast;
      document.getElementById("blast-buttons").style.display = "none";
      sendRoundData();
    }
  </script>
</head>
<body>
  <h1>Reaction Time Game</h1>
  <p id="instructions">Click "Start" to play!</p>
  <button onclick="startReaction()">Start</button>
  <button id="react" onclick="react()" style="display: none;">React!</button>

  <div id="blast-buttons" style="display: none;">
    <p>Select a blast level:</p>
    <button onclick="submitBlast(1)">1</button>
    <button onclick="submitBlast(2)">2</button>
    <button onclick="submitBlast(3)">3</button>
    <button onclick="submitBlast(4)">4</button>
    <button onclick="submitBlast(5)">5</button>
    <button onclick="submitBlast(6)">6</button>
    <button onclick="submitBlast(7)">7</button>
    <button onclick="submitBlast(8)">8</button>
  </div>
</body>
</html>
